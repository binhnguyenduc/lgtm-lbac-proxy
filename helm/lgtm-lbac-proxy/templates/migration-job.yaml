{{- if .Values.migration.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "lgtm-lbac-proxy.name" . }}-migrate-labels
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "lgtm-lbac-proxy.labels" . | nindent 4 }}
    app.kubernetes.io/component: migration
  annotations:
    "helm.sh/hook": {{ .Values.migration.hookType }}
    "helm.sh/hook-weight": "{{ .Values.migration.hookWeight }}"
    "helm.sh/hook-delete-policy": {{ .Values.migration.hookDeletePolicy }}
spec:
  backoffLimit: {{ .Values.migration.backoffLimit }}
  template:
    metadata:
      labels:
        {{- include "lgtm-lbac-proxy.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: migration
    spec:
      restartPolicy: {{ .Values.migration.restartPolicy }}
      serviceAccountName: {{ include "lgtm-lbac-proxy.serviceAccountName" . }}
      securityContext:
        {{- toYaml .Values.proxy.podSecurityContext | nindent 8 }}
      containers:
      - name: migrate-labels
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        securityContext:
          {{- toYaml .Values.proxy.securityContext | nindent 10 }}
        command:
          - /bin/sh
          - -c
          - |
            echo "Starting label migration..."

            # Check if migration tool exists
            if [ ! -f /migrate-labels ]; then
              echo "ERROR: Migration tool not found at /migrate-labels"
              echo "Please ensure the migration tool is included in the image"
              exit 1
            fi

            # Create backup
            if [ -f /etc/config/labels/labels.yaml ]; then
              echo "Creating backup..."
              cp /etc/config/labels/labels.yaml /tmp/labels.yaml.backup
              echo "Backup created at /tmp/labels.yaml.backup"
            else
              echo "No labels.yaml found, skipping migration"
              exit 0
            fi

            # Run migration with validation first
            echo "Validating current labels..."
            /migrate-labels -input /etc/config/labels/labels.yaml -validate

            {{- if .Values.migration.dryRun }}
            # Dry run mode - preview only
            echo "Running in dry-run mode (preview only)..."
            /migrate-labels -input /etc/config/labels/labels.yaml \
              -default-label {{ .Values.migration.defaultLabel }} \
              -dry-run
            {{- else }}
            # Actual migration
            echo "Converting to extended format..."
            /migrate-labels -input /etc/config/labels/labels.yaml \
              -output /tmp/labels-extended.yaml \
              -default-label {{ .Values.migration.defaultLabel }}

            # Show the converted file
            echo "Converted labels:"
            cat /tmp/labels-extended.yaml

            # Output instructions
            echo ""
            echo "========================================="
            echo "Migration complete!"
            echo "========================================="
            echo "Next steps:"
            echo "1. Review the converted labels above"
            echo "2. Update your labels ConfigMap with the new format"
            echo "3. Restart the proxy pods to apply changes"
            echo ""
            echo "To update the ConfigMap:"
            echo "kubectl create configmap {{ include "lgtm-lbac-proxy.name" . }}-labels \\"
            echo "  --from-file=labels.yaml=/tmp/labels-extended.yaml \\"
            echo "  --namespace {{ .Release.Namespace }} \\"
            echo "  --dry-run=client -o yaml | kubectl apply -f -"
            {{- end }}
        volumeMounts:
          - name: labels
            mountPath: /etc/config/labels
            readOnly: true
          - name: tmp
            mountPath: /tmp
        resources:
          {{- toYaml .Values.migration.resources | nindent 10 }}
      volumes:
        - name: labels
          configMap:
            name: {{ .Values.migration.labelsConfigMap | default (printf "%s-labels" (include "lgtm-lbac-proxy.name" .)) }}
        - name: tmp
          emptyDir: {}
{{- end }}
