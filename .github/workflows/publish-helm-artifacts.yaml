name: Publish Helm Chart Artifacts

on:
  workflow_dispatch:
    inputs:
      chart_path:
        description: Relative path to the chart directory (e.g. helm/lgtm-lbac-proxy)
        required: false
        default: helm/lgtm-lbac-proxy
      chart_repo_url:
        description: Public URL of the artifact repository (https://binhnguyenduc.github.io/helm-charts/)
        required: false
        default: https://binhnguyenduc.github.io/helm-charts/
      artifact_repo:
        description: GitHub owner/repo that stores packaged charts
        required: false
        default: binhnguyenduc/helm-charts
  release:
    types: [published]
  push:
    tags:
      - 'helm-*'

concurrency:
  group: publish-helm-artifacts-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    env:
      HELM_CHART_PATH: ${{ inputs.chart_path || 'helm/lgtm-lbac-proxy' }}
      HELM_REPO_URL: ${{ inputs.chart_repo_url || 'https://binhnguyenduc.github.io/helm-charts/' }}
      ARTIFACT_REPO: ${{ inputs.artifact_repo || 'binhnguyenduc/helm-charts' }}
    steps:
      - name: Checkout chart source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine chart path when triggered automatically
        if: ${{ !inputs.chart_path }}
        id: autodetect
        shell: bash
        run: |
          echo "Autodetecting chart path..."
          DEFAULT_PATH=$(find helm -maxdepth 1 -mindepth 1 -type d | head -n1)
          if [[ -z "$DEFAULT_PATH" ]]; then
            echo "No chart found under helm/. Set chart_path input."
            exit 1
          fi
          echo "path=$DEFAULT_PATH" >> "$GITHUB_OUTPUT"

      - name: Set chart path
        if: ${{ !inputs.chart_path }}
        run: echo "HELM_CHART_PATH=${{ steps.autodetect.outputs.path }}" >> "$GITHUB_ENV"

      - name: Set repo URL defaults
        if: ${{ !inputs.chart_repo_url }}
        run: |
          OWNER="${ARTIFACT_REPO%/*}"
          REPO="${ARTIFACT_REPO#*/}"
          echo "HELM_REPO_URL=https://${OWNER}.github.io/${REPO}/" >> "$GITHUB_ENV"

      - name: Ensure chart path exists
        run: |
          if [[ ! -f "${HELM_CHART_PATH}/Chart.yaml" ]]; then
            echo "Chart.yaml not found at ${HELM_CHART_PATH}"
            exit 1
          fi

      - name: Validate HELM_REPO_PUSH_TOKEN secret
        env:
          TOKEN: ${{ secrets.HELM_REPO_PUSH_TOKEN }}
        run: |
          if [[ -z "$TOKEN" ]]; then
            echo "❌ ERROR: HELM_REPO_PUSH_TOKEN secret is not set"
            echo "Please add HELM_REPO_PUSH_TOKEN to repository secrets"
            echo "Go to: Settings -> Secrets and variables -> Actions"
            exit 1
          fi
          echo "✅ HELM_REPO_PUSH_TOKEN secret is configured"

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Prepare dependencies
        shell: bash
        run: |
          helm dependency update "${HELM_CHART_PATH}" || true

      - name: Lint chart
        run: helm lint "${HELM_CHART_PATH}"

      - name: Package chart
        id: package
        shell: bash
        run: |
          mkdir -p dist

          # Extract chart metadata first
          CHART_NAME=$(helm show chart "${HELM_CHART_PATH}" | grep '^name:' | awk '{print $2}' | tr -d ' ')
          CHART_VERSION=$(helm show chart "${HELM_CHART_PATH}" | grep '^version:' | awk '{print $2}' | tr -d ' ')

          echo "Chart: ${CHART_NAME}"
          echo "Version: ${CHART_VERSION}"

          # Package the chart
          helm package "${HELM_CHART_PATH}" --destination dist

          # Construct expected package path
          PACKAGE_PATH="dist/${CHART_NAME}-${CHART_VERSION}.tgz"

          # Verify package exists
          if [[ ! -f "$PACKAGE_PATH" ]]; then
            echo "ERROR: Expected package not found at ${PACKAGE_PATH}"
            echo "Available packages:"
            ls -la dist/
            exit 1
          fi

          echo "package_path=$PACKAGE_PATH" >> "$GITHUB_OUTPUT"
          echo "chart_name=$CHART_NAME" >> "$GITHUB_OUTPUT"
          echo "chart_version=$CHART_VERSION" >> "$GITHUB_OUTPUT"

      - name: Checkout artifact repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.ARTIFACT_REPO }}
          token: ${{ secrets.HELM_REPO_PUSH_TOKEN }}
          ref: main
          path: artifact-repo

      - name: Sync packaged chart
        shell: bash
        working-directory: artifact-repo
        env:
          PACKAGE_PATH: ${{ steps.package.outputs.package_path }}
          CHART_NAME: ${{ steps.package.outputs.chart_name }}
          CHART_VERSION: ${{ steps.package.outputs.chart_version }}
        run: |
          # Copy chart to root of artifact repo
          CHART_FILE="${CHART_NAME}-${CHART_VERSION}.tgz"
          cp "${GITHUB_WORKSPACE}/${PACKAGE_PATH}" "${CHART_FILE}"

          echo "Copied ${CHART_FILE} to artifact repository root"
          ls -lh "${CHART_FILE}"

      - name: Update index.yaml
        shell: bash
        working-directory: artifact-repo
        env:
          HELM_REPO_URL: ${{ env.HELM_REPO_URL }}
        run: |
          # Create empty index if it doesn't exist
          if [[ ! -f index.yaml || ! -s index.yaml ]]; then
            printf 'apiVersion: v1\nentries: {}\ngenerated: 1970-01-01T00:00:00Z\n' > index.yaml
          fi

          # Generate new index (this will create a new index.yaml in current dir)
          helm repo index . --url "${HELM_REPO_URL}" --merge index.yaml

          echo "Updated index.yaml"
          echo "Index entries:"
          grep -A 2 "urls:" index.yaml || echo "No entries yet"

      - name: Commit and push artifacts
        working-directory: artifact-repo
        env:
          CHART_NAME: ${{ steps.package.outputs.chart_name }}
          CHART_VERSION: ${{ steps.package.outputs.chart_version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Add chart package and index
          CHART_FILE="${CHART_NAME}-${CHART_VERSION}.tgz"
          git add "${CHART_FILE}" index.yaml

          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "No changes to publish."
            exit 0
          fi

          # Show what's being committed
          echo "Changes to be committed:"
          git diff --cached --name-status

          # Commit and push
          git commit -m "Publish ${CHART_NAME} ${CHART_VERSION}"
          git push origin main

          echo "✅ Successfully published ${CHART_NAME} ${CHART_VERSION}"

      - name: Output published artifact metadata
        run: |
          echo "Published chart: ${{ steps.package.outputs.chart_name }}"
          echo "Version: ${{ steps.package.outputs.chart_version }}"
          echo "Repository: ${{ env.ARTIFACT_REPO }}"
